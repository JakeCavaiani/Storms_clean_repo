---
title: "10_gls_models"
author: "Jake Cavaiani"
date: "9/12/2022"
output:
  word_document: default
  html_document: default
  pdf_document: default
---
#load libraries 
```{r}
library(here)
library(tidyverse)
library(nlme)
library(forecast)
library(stats)
library(readr)
library(ggplot2)
library(plotly)
library(GGally)
library(ggpmisc)
library(ggpubr)
library(ggExtra)
library(lubridate)
library(nlme)
library(MuMIn)
library(multcomp)
```



```{r setup, include=FALSE}
mean_daily <- read.csv("~/Documents/Storms_clean_repo/Output_from_analysis/08_Catchment_characteristics/mean_daily.csv")

mean_daily$datetimeAK <- ymd(mean_daily$day)
mean_daily <- mean_daily[order(mean_daily$year, mean_daily$site.ID), ]

mean_daily$year <- as.character(mean_daily$year)

mean_daily_site <- mean_daily %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanNO3 = mean(dailyNO3, na.rm = TRUE),
                   meanfDOM = mean(dailyfDOM, na.rm = TRUE),
                   mean = mean(dailySPC, na.rm = TRUE),
                   meanTurb = mean(dailyTurb, na.rm = TRUE))



mean_daily_long <- mean_daily %>%
  pivot_longer(
    cols = starts_with("daily"),
    names_to = "response_var",
    names_prefix = "wk",
    values_to = "concentration",
    values_drop_na = TRUE
  ) # converting to a long format so each response_var is within a single column

NO3_data <- subset(mean_daily_long, response_var == "dailyNO3" )

mean_daily_character <- mean_daily
mean_daily_character$year <- as.character(mean_daily_character$year)
```

```{r}
ggplot(mean_daily, aes(x = julian, y = dailyNO3, color = site.ID)) +
  geom_point() +
  facet_grid(site.ID ~ year, scales = "free") +
  theme_classic()


```
comparing each group to the base case (CARI) (and year of 2018) The intercept is the mean for CARI and the p-value 
each row for site is comparing that catchment mean across all years and site 
mean differs for caribou 
use a post hoc test to find 
if there is a significant interaction than we will run a post hoc test on the interaction 

# Linear model #
```{r}
no3.mod <- lm(dailyNO3 ~ site.ID*year,
              data = mean_daily_character)

summary(no3.mod)

```

# no correlation structure #
```{r}
mean_daily_character_dropped <- transform(na.omit(mean_daily_character), site.IDyear=droplevels(interaction(site.ID,year)))

no3.mod.gls <- gls(dailyNO3 ~ site.ID*year,
                   na.action = na.omit,
                   data = mean_daily_character_dropped)
summary(no3.mod.gls)

```


# corAR1 structure 
```{r}
no3.mod.ar1 <- gls(dailyNO3 ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily_character, 
               correlation = corAR1(form = ~ julian|site.ID/year),
               control = list(singular.ok = TRUE))

#### Dont do control = list(singular.ok = TRUE)
# might have to do model separate by year 

summary(no3.mod.ar1) # Phi1 = 0.9844227  

```
The residuals do not look like they are normally distributed 

# diagnostic plots 
```{r}
plot(no3.mod.ar1, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.ar1, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.ar1, abline = c(0,1))

```
Let me log transform to see if its better
```{r}
mean_daily$logdailyNO3 <- log((mean_daily$dailyNO3))
#mean_daily$site.ID <- as.factor(mean_daily$site.ID)

no3.mod.ar1.log <- gls(logdailyNO3 ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year),
               control = list(singular.ok = TRUE))

summary(no3.mod.ar1.log) # Phi1 = 0.9844227  

```

# diagnostic plots 
```{r}
plot((no3.mod.ar1.log))

plot(no3.mod.ar1.log, resid(., type = "p") ~ fitted(.) | site.ID, abline = 0)

plot(no3.mod.ar1.log, logdailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.ar1.log, abline = c(0,1))

```

#ACF plots 
```{r}
Ear1<-residuals(no3.mod.ar1, type="normalized")
I1<-!is.na(mean_daily$dailyNO3)
Efulla<-vector(length = length(mean_daily$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```


# corARMA structure 
```{r}
no3.mod.arma.1 <- gls(logdailyNO3 ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 1),
               control = list(singular.ok = TRUE))

no3.mod.arma.2 <- gls(logdailyNO3 ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 2))

no3.mod.arma.4 <- gls(logdailyNO3 ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 2))

AIC(no3.mod.arma.1, no3.mod.arma.2, no3.mod.arma.4)


summary(no3.mod.arma.1) # Phi1 = 0.9844227  

```
The residuals do not look like they are normally distributed 

# diagnostic plots 
```{r}
plot((no3.mod.arma.1))

plot(no3.mod.arma.1, resid(., type = "p") ~ fitted(.) | site.ID, abline = 0)

plot(no3.mod.arma.1, logdailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.arma.1, abline = c(0,1))

```

```{r}
Ear1<-residuals(no3.mod.arma.1, type="normalized")
I1<-!is.na(mean_daily$logdailyNO3)
Efulla<-vector(length = length(mean_daily$logdailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```

# generalized linear hypotheses
```{r}

site.ID.comp <- glht(no3.mod.arma.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

TukeyHSD(no3.mod.arma.2, which = "siteID")

summary(no3.mod.arma.2)
intervals(no3.mod.arma.2)

```


### fDOM ### 
```{r}
ggplot(mean_daily, aes(x = julian, y = dailyfDOM, color = site.ID)) +
  geom_line() +
  facet_grid(site.ID ~ year, scales = "free") +
  theme_classic()


```

# no correlation structure #
```{r} 
fDOM.mod <- gls(dailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily)

summary(fDOM.mod) 

```

# corAR1 structure 
```{r}
fDOM.mod.ar1 <- gls(dailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(fDOM.mod.ar1) 

```
The residuals do not look like they are normally distributed 

# diagnostic plots 
```{r}
plot((fDOM.mod.ar1))

plot(fDOM.mod.ar1, resid(., type = "p") ~ fitted(.) | site.ID, abline = 0)

plot(fDOM.mod.ar1, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.ar1, abline = c(0,1))

```

Let me log transform to see if its better

# log transformed 
```{r}
mean_daily$logdailyfDOM <- log(mean_daily$dailyfDOM)
mean_daily[c(1685,2031), 13] <- NA # removing clear outliers
# First one is FRCH 8/5/21 where fDOM is 2 
# second one is VAUL 8/15/21 where fDOM is 3 and then ~140 the next day

fDOM.mod.ar1.log <- gls(logdailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(fDOM.mod.ar1.log) 


```
Residuals look a lot better

# diagnostic plots 
```{r}
plot(fDOM.mod.ar1.log)

plot(fDOM.mod.ar1.log, resid(., type = "p") ~ fitted(.) | site.ID, abline = 0)

plot(fDOM.mod.ar1.log, logdailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.ar1.log, abline = c(0,1))

```
Looks much better

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily$logdailyfDOM)
Efulla<-vector(length = length(mean_daily$logdailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```
AR1 is not adequately handling the temporal autocorrelation 

# generalized linear hypotheses
```{r}

site.ID.comp <- glht(fDOM.mod.ar1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))


```
This shows that only FRCH and CARI are significantly different from each other? I would have expected more to be significantly different from each other just looking at our figures

# corARMA structure 
```{r}
fDOM.mod.arma.1 <- gls(logdailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 1))

fDOM.mod.arma.2 <- gls(logdailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 2))

fDOM.mod.arma.3 <- gls(logdailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 1))

fDOM.mod.arma.4 <- gls(logdailyfDOM ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 2))

AIC(fDOM.mod.arma.1, fDOM.mod.arma.2, fDOM.mod.arma.3, fDOM.mod.arma.4, fDOM.mod.ar1.log)


summary(fDOM.mod.arma.1) 

```
The residuals look good 

# diagnostic plots 
```{r}

plot(fDOM.mod.arma.1, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.arma.1, logdailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.arma.1, abline = c(0,1))

```


```{r}
Ear1<-residuals(fDOM.mod.arma.1, type="normalized")
I1<-!is.na(mean_daily$logdailyfDOM)
Efulla<-vector(length = length(mean_daily$logdailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```


# generalized linear hypotheses
```{r}

site.ID.comp <- glht(fDOM.mod.arma.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

```

### SPC ### 
```{r}
ggplot(mean_daily, aes(x = julian, y = dailySPC, color = site.ID)) +
  geom_line() +
  facet_grid(site.ID ~ year, scales = "free") +
  theme_classic()


```

# corAR1 structure 
```{r}
SPC.mod.ar1 <- gls(dailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(SPC.mod.ar1) 

```
The residuals dont look too too too bad

# diagnostic plots 
```{r}
plot(resid(SPC.mod.ar1, type = "normalized"))

plot(SPC.mod.ar1, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.ar1, dailySPC ~ fitted(.), abline = c(0,1))

qqnorm(SPC.mod.ar1, abline = c(0,1))

```
Let me log transform to see if its better

# log transformed 
```{r}
mean_daily$logdailySPC <- log(mean_daily$dailySPC)


SPC.mod.ar1.log <- gls(logdailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(SPC.mod.ar1.log) 


```
Residuals still dont look great for the max and min 

# diagnostic plots 
```{r}
plot(resid(SPC.mod.ar1.log, type = "normalized"))

plot(SPC.mod.ar1.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.ar1.log, logdailySPC ~ fitted(.), abline = c(0,1))

qqnorm(SPC.mod.ar1.log, abline = c(0,1))

```
our normality plot looks better but still not perfect 


# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily$logdailySPC)
Efulla<-vector(length = length(mean_daily$logdailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.ar1.log, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

```
This shows that none of our sites SPC concentration is significantly different but VAUL is so much higher than the rest of the sites....I dont know if im doing this glht fucntion correctly 

# corARMA structure 
```{r}
SPC.mod.arma.1 <- gls(logdailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 1))

SPC.mod.arma.2 <- gls(logdailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 2))

SPC.mod.arma.3 <- gls(logdailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 1))

SPC.mod.arma.4 <- gls(logdailySPC ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 2))

AIC(SPC.mod.arma.1, SPC.mod.arma.2, SPC.mod.arma.3, SPC.mod.arma.4, SPC.mod.ar1.log)


summary(SPC.mod.arma.1) 

```
The residuals do not look perfect


# diagnostic plots 
```{r}
plot(resid(SPC.mod.arma.1, type = "normalized"))

plot(SPC.mod.arma.1, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.arma.1, logdailySPC ~ fitted(.), abline = c(0,1))

qqnorm(SPC.mod.arma.1, abline = c(0,1))

```



```{r}
Ear1<-residuals(SPC.mod.arma.1, type="normalized")
I1<-!is.na(mean_daily$logdailySPC)
Efulla<-vector(length = length(mean_daily$logdailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```
Still getting temporal autocorrelation for the first few lags 

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.arma.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

```

### turb ### 
```{r}
ggplot(mean_daily, aes(x = julian, y = dailyTurb, color = site.ID)) +
  geom_line() +
  facet_grid(site.ID ~ year, scales = "free") +
  theme_classic()


```

# corAR1 structure 
```{r}
turb.mod.ar1 <- gls(dailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(turb.mod.ar1) 

```
The residuals look really bad 



# diagnostic plots 
```{r}
plot(resid(turb.mod.ar1, type = "normalized"))

plot(turb.mod.ar1, resid(., type = "p") ~ fitted(.) | site.ID, abline = 0)

plot(turb.mod.ar1, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.ar1, abline = c(0,1))

```


# log transformed 
```{r}
mean_daily$logdailyTurb <- log(mean_daily$dailyTurb)


turb.mod.ar1.log <- gls(logdailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corAR1(form = ~ julian|site.ID/year))

summary(turb.mod.ar1.log) 


```

# diagnostic plots 
```{r}
plot(resid(turb.mod.ar1.log, type = "normalized"))

plot(turb.mod.ar1.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.ar1.log, logdailyTurb ~ fitted(.), abline = c(0,1))

qqnorm(turb.mod.ar1.log, abline = c(0,1))

```
our normality plot looks better but still not great....

```{r}
Ear1<-residuals(turb.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily$logdailyTurb)
Efulla<-vector(length = length(mean_daily$logdailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```


# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.ar1.log, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

```
This shows that none of our sites Turb concentration are significantly different 


# corARMA structure 
```{r}
turb.mod.arma.1 <- gls(logdailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 1))

turb.mod.arma.2 <- gls(logdailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 1, q = 2))

turb.mod.arma.3 <- gls(logdailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 1))

turb.mod.arma.4 <- gls(logdailyTurb ~ site.ID*year, 
               na.action = na.omit, 
               data = mean_daily, 
               correlation = corARMA(form = ~ julian|site.ID/year, p = 2, q = 2))

AIC(turb.mod.arma.1, turb.mod.arma.2, turb.mod.arma.3, turb.mod.arma.4, turb.mod.ar1.log)


summary(turb.mod.arma.2) 

```
The residuals do not look perfect

# diagnostic plots 
```{r}
plot(resid(turb.mod.arma.2, type = "normalized"))

plot(turb.mod.arma.2, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.arma.2, logdailyTurb ~ fitted(.), abline = c(0,1))

qqnorm(turb.mod.arma.2, abline = c(0,1))

```

```{r}
Ear1<-residuals(turb.mod.arma.2, type="normalized")
I1<-!is.na(mean_daily$logdailyTurb)
Efulla<-vector(length = length(mean_daily$logdailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)

```
No autocorrelation until lag 5 



# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.arma.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
plot(print(confint(site.ID.comp)))

```

