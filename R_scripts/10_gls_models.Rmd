---
title: "10_gls_models"
author: "Jake Cavaiani"
date: "9/12/2022"
output:
  word_document: default
  html_document: default
  pdf_document: default
---
The purpose of this script is to compare mean concentrations of measured constituents across catchments over a common period of observation (TSC 32-145) within each year using generalized least square models (GLS) that accounted for temporal autocorrelation of daily observations

Input: Mean_daily file from 08_Catchment_Analysis script that is located in "Storms_clean_repo/Output_from_analysis/08_Catchment_characteristics/mean_daily.csv"

Step 1) import full file 
Step 2) model without autocorrelation structure or transformations
Step 3) Check model assumptions
Step 4) Transform if needed (log/heterogeneous variances)
Step 5) Add correlation structure- ususually ARMA needed to be used: 

mod <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_xxxx, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
               
Step 6) Check ACF and PACF plots for autocorrelation 
Step 7)*if necessary use AIC to determine which autocorrelation structure is most appropriate 
Step 8) Post-hoc analysis - pairwise comparison if there is significance among site
Step 9) plot box plots

This script also contains CVs of each constituent
-Perform linear regression to compare CVs

Output: boxplots with letters signifying difference 

#load libraries 
```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(nlme)
library(forecast)
library(stats)
library(readr)
library(ggplot2)
library(plotly)
library(GGally)
library(ggpmisc)
library(ggpubr)
library(ggExtra)
library(lubridate)
library(nlme)
# library(MuMIn)
library(multcomp)
library(sjPlot)
library(AICcmodavg)
library(stats)
library(lme4)
library(emmeans)
library(ggpattern)
library(grid)
library(pBrackets)
library(multcompView)
library(lmerTest)
```



```{r}

mean_daily <- read.csv(here("Output_from_analysis", "08_Catchment_characteristics", "mean_daily.csv"))

mean_daily$datetimeAK <- ymd(mean_daily$day)
mean_daily <- mean_daily[order(mean_daily$year, mean_daily$site.ID), ]

mean_daily$year <- as.character(mean_daily$year)

mean_daily$Burn <- NA

mean_daily <- mean_daily %>% 
  mutate(across(c(Burn),
                ~ifelse(site.ID == "CARI" | site.ID == "FRCH" | site.ID == "VAUL", "unburned", "burned")))

mean_daily$PF <- NA

mean_daily <- mean_daily %>% 
  mutate(across(c(PF),
                ~ifelse(site.ID == "VAUL" | site.ID == "STRT", "High", "Moderate")))


vn = expression(paste(N*O[3]^"-"))
# mean concentration across years for each site 
mean_daily_site <- mean_daily %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanNO3 = mean(dailyNO3, na.rm = TRUE),
                   meanfDOM = mean(dailyfDOM, na.rm = TRUE),
                   meanSPC = mean(dailySPC, na.rm = TRUE),
                   meanTurb = mean(dailyTurb, na.rm = TRUE))

write.csv(mean_daily_site, "~/Documents/Storms_clean_repo/Output_from_analysis/10_gls_models/mean_daily_site.csv")



mean_daily_long <- mean_daily %>%
  pivot_longer(
    cols = starts_with("daily"),
    names_to = "response_var",
    names_prefix = "wk",
    values_to = "concentration") # converting to a long format so each response_var is within a single column

ggplot(mean_daily_long, aes(x = julian, y = concentration, color = site.ID)) +
  geom_point(size = 0.5) +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_grid(response_var~year, scales = "free") +
  theme_classic()


```

### BY YEAR ###
Due to the fact that we dont have data for 3 of the sites for 2018 the gls structure does not like that...so we will try this analysis by year and see if concentrations vary significantly from each other within years 

# NO3 # 

# CorAR1 structure #
```{r}
mean_daily_2018 <- subset(mean_daily, year == "2018")

ggplot(mean_daily_2018, aes(x = julian, y = dailyNO3, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

ggplot(mean_daily_2018, aes(x = site.ID, y = dailyNO3, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D"), "Site") +
  theme_classic() + 
  xlab("Site") +
  ylab(vn) 

```

### no autocorrelation structure
```{r}
no3.mod.gls.2018 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)

```
# diagnostic plots 
```{r}
plot(no3.mod.gls.2018, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls.2018, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls.2018, ~ resid(., type = "p"), abline = c(0, 1))
```
Our normality is not great...lets log transform 

```{r}
mean_daily_2018$logDailyNO3 <- log(abs(mean_daily_2018$dailyNO3))

no3.mod.gls.2018.log <- gls(logDailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)
```

# diagnostic plots 
```{r}
plot(no3.mod.gls.2018.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls.2018.log, logDailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls.2018.log, ~ resid(., type = "p"), abline = c(0, 1))

```
We are going to use the untransformed data here 

# corAR1 structure 
```{r}
no3.mod.ar1.2018 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corAR1(form = ~ julian|site.ID))

```

# ACF plot 
```{r}
Ear1<-residuals(no3.mod.ar1.2018, type="normalized")
I1<-!is.na(mean_daily_2018$dailyNO3)
Efulla<-vector(length = length(mean_daily_2018$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
no3.mod.arma.1.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(no3.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2018$dailyNO3)
Efulla<-vector(length = length(mean_daily_2018$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# corARMA structure 
```{r}
no3.mod.arma.1.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(no3.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2018$dailyNO3)
Efulla<-vector(length = length(mean_daily_2018$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# corARMA structure 
```{r}
no3.mod.arma.2.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(no3.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2018$dailyNO3)
Efulla<-vector(length = length(mean_daily_2018$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```

# corARMA structure 
```{r}
no3.mod.arma.2.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(no3.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2018$dailyNO3)
Efulla<-vector(length = length(mean_daily_2018$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# AIC 
```{r}
models <- list(no3.mod.ar1.2018,no3.mod.arma.1.1, no3.mod.arma.1.2, no3.mod.arma.2.1, no3.mod.arma.2.2)
aictab(cand.set = models) # no3.mod.arma.1.1 is the best model
```
# generalized linear hypotheses
```{r}
mean_daily_2018$site.ID <-as.factor(mean_daily_2018$site.ID)
site.ID.comp <- glht(no3.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp) # no site is significantly different 
summary(no3.mod.arma.1.1)
intervals(no3.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(no3.mod.arma.1.1)

```

### fDOM ### 
```{r}
ggplot(mean_daily_2018, aes(x = julian, y = dailyfDOM, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

fDOM.2018 <- ggplot(mean_daily_2018, aes(x = site.ID, y = dailyfDOM, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D"), "Site") +
  xlab("") +
  ylab("Daily fDOM (QSU)") +
  theme_classic()

```



# gls  
```{r}
fDOM.mod.2018 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)

```

# diagnostic plots 
```{r}
plot(fDOM.mod.2018, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.2018, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.2018, ~ resid(., type = "p"), abline = c(0, 1))

```

Let me log transform to see if its better

# log transformed 
```{r}
mean_daily_2018$logDailyfDOM <- log(mean_daily_2018$dailyfDOM)

# removing clear outliers here 
which(mean_daily_2018$logDailyfDOM > 5.4)

mean_daily_2018 <- mean_daily_2018 %>%
  mutate(across(c(logDailyfDOM), 
                ~ifelse(logDailyfDOM > 5.4, NA, .)))


fDOM.mod.ar1.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)
```


# diagnostic plots 
```{r}
plot(fDOM.mod.ar1.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.ar1.log, logDailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.ar1.log, ~ resid(., type = "p"), abline = c(0, 1))

```
Still has some hetergenous variance...lets fix that here 

```{r}
varfixed <- varIdent(form = ~ 1 | site.ID)
fDOM.mod.ar1.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018,
               weights = varfixed)


```

# diagnostic plots 
```{r}
plot(fDOM.mod.ar1.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.ar1.log, logDailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.ar1.log, ~ resid(., type = "p"), abline = c(0, 1))

```
Normality checks out...variance looks pretty good after adjusting weights 

# corAR1 structure
```{r}
fDOM.mod.ar1.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corAR1(form = ~ julian|site.ID))
```
# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2018$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.1.1 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2018$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.2.1 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2018$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
gets worse in the later lags

# corARMA structure 
```{r}
fDOM.mod.arma.1.2 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2018$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
fDOM.mod.arma.2.2 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2018$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation but this is the best one yet so lets interpret this model 

```{r}
models <- list(fDOM.mod.arma.1.1, fDOM.mod.arma.1.2, fDOM.mod.arma.2.1, fDOM.mod.arma.2.2)
aictab(cand.set = models) # fDOM.mod.arma.1.2 is the best model
```


# generalized linear hypotheses
```{r}
site.ID.comp <- glht(fDOM.mod.arma.1.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(fDOM.mod.arma.1.2)

plot(print(confint(site.ID.comp)))
tab_model(fDOM.mod.arma.1.2)
anova(fDOM.mod.arma.1.2)

```
This shows that FRCH and CARI are significantly different from MOOS


### SPC ### 
```{r}
ggplot(mean_daily_2018, aes(x = julian, y = dailySPC, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

spc.2018 <- ggplot(mean_daily_2018, aes(x = site.ID, y = dailySPC, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D"), "Site") +
  xlab("") +
  ylab("Daily SPC (µS/cm)") +
  theme_classic()
```
#gls
```{r}
SPC.mod <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)

```

# diagnostic plots 
```{r}
plot(SPC.mod, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod, ~ resid(., type = "p"), abline = c(0, 1))

```
Variance looks good, so does qqnorm plot 

# corAR1 structure 
```{r}
SPC.mod.ar1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.ar1, type="normalized")
I1<-!is.na(mean_daily_2018$dailySPC)
Efulla<-vector(length = length(mean_daily_2018$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.1.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2018$dailySPC)
Efulla<-vector(length = length(mean_daily_2018$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation at the 9th lag but that is it

# corARMA structure 
```{r}
SPC.mod.arma.2.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2018$dailySPC)
Efulla<-vector(length = length(mean_daily_2018$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still that 9th lag

# corARMA structure 
```{r}
SPC.mod.arma.1.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2018$dailySPC)
Efulla<-vector(length = length(mean_daily_2018$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
SPC.mod.arma.2.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2018$dailySPC)
Efulla<-vector(length = length(mean_daily_2018$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(SPC.mod.ar1, SPC.mod.arma.1.1, SPC.mod.arma.1.2, SPC.mod.arma.2.1, SPC.mod.arma.2.2)
aictab(cand.set = models) # SPC.mod.arma.1.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(SPC.mod.arma.1.1)
intervals(SPC.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(SPC.mod.arma.1.1)

```
This shows that MOOS is significantly different than CARI and FRCH 

### Turb ### 
```{r}
ggplot(mean_daily_2018, aes(x = julian, y = dailyTurb, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

turb.2018 <- ggplot(mean_daily_2018, aes(x = site.ID, y = dailyTurb, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D"), "Site") +
  xlab("") +
  ylab("Daily Turbidity (FNU)") +
  theme_classic()
```

# gls
```{r}
turb.mod <- gls(dailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)
```

# diagnostic plots 
```{r}
plot(turb.mod, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod, ~ resid(., type = "p"), abline = c(0, 1))

```
Looks like we have lots of outliers here but our normality isnt good either so lets log transform first and then investigate outliers

# gls 
```{r}
mean_daily_2018$logDailyTurb <- log(mean_daily_2018$dailyTurb)
turb.mod.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018)

```

# diagnostic plots 
```{r}
plot(turb.mod.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.log, logDailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.log, ~ resid(., type = "p"), abline = c(0,1))

```
This heavy tail is unlikely causing bias in the terms that we are interpreting but lets see if we can do something about the hetergenous variance 

# gls 
```{r}
turb.mod.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit,
               weights = varfixed,
               data = mean_daily_2018)

```

# diagnostic plots 
```{r}
plot(turb.mod.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.log, logDailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.log, ~ resid(., type = "p"), abline = c(0,1))

```
# corAR1 structure 
```{r}
turb.mod.ar1.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018, 
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))

```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2018$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 structure is not adequately handling temporal autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2018,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2018$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2018$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
This looks good!

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(turb.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(turb.mod.arma.1.1)

```
This shows no significance for any of the sites 


# 2019 #
```{r}
mean_daily_2019 <- subset(mean_daily, year == "2019")
mean_daily_2019$site.ID <- as.factor(mean_daily_2019$site.ID)
ggplot(mean_daily_2019, aes(x = julian, y = dailyNO3, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

ggplot(mean_daily_2019, aes(x = site.ID, y = dailyNO3, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  theme_classic()
```

# gls 
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019)
```

# diagnostic plots 
```{r}
plot(no3.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
looks like FRCH has greater variance 

```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed)
```

# diagnostic plots 
```{r}
plot(no3.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
how does log transformation look 
```{r}
mean_daily_2019$logDailyNO3 <- log(mean_daily_2019$dailyNO3)

no3.mod.gls.log <- gls(logDailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed)
```

# diagnostic plots 
```{r}
plot(no3.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls.log, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls.log, ~resid(., type = "p"), abline = c(0,1))

```
lets stick with untransformed 

# CorAR1 structure #
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(no3.mod.gls, type="normalized")
I1<-!is.na(mean_daily_2019$dailyNO3)
Efulla<-vector(length = length(mean_daily_2019$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 isnt doing horribly but lets try to go with the corARMA structure... 

# corARMA structure 
```{r}
NO3.mod.arma.1.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailyNO3)
Efulla<-vector(length = length(mean_daily_2019$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
This is worse than the corAR1

# corARMA structure 
```{r}
NO3.mod.arma.2.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailyNO3)
Efulla<-vector(length = length(mean_daily_2019$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
NO3.mod.arma.1.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailyNO3)
Efulla<-vector(length = length(mean_daily_2019$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```

# corARMA structure 
```{r}
NO3.mod.arma.2.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailyNO3)
Efulla<-vector(length = length(mean_daily_2019$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(NO3.mod.arma.2.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(NO3.mod.arma.2.2)

plot(print(confint(site.ID.comp)))
anova(NO3.mod.arma.2.2)

```
This shows no significance for any of the sites 


### fDOM ### 
```{r}
ggplot(mean_daily_2019, aes(x = julian, y = dailyfDOM, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

fDOM.2019 <- ggplot(mean_daily_2019, aes(x = site.ID, y = dailyfDOM, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("") +
  ylab("") +
  theme_classic()
```
# gls 
```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019)
               
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~ resid(., type = "p"),  abline = c(0,1))

```
lets try to adjust the variance 

# gls 
```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2019)
               
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~ resid(., type = "p"),  abline = c(0,1))

```
lets do a log transform 

```{r}
mean_daily_2019$logDailyfDOM <- log(mean_daily_2019$dailyfDOM)

fDOM.mod.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed)

```

# diagnostic plots 
```{r}
plot(fDOM.mod.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.log, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.log, ~ resid(., type = "p"),  abline = c(0,1))

```
we will go with the log transformed 

# corAR1 structure 
```{r}
fDOM.mod.ar1.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2019$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.1.1 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2019$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.2.1 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
                weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2019$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
gets worse in the later lags

# corARMA structure 
```{r}
fDOM.mod.arma.1.2 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2019$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
fDOM.mod.arma.2.2 <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
              weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyfDOM)
Efulla<-vector(length = length(mean_daily_2019$logDailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation but this is the best one yet so lets interpret this model 

# AIC 
```{r}
models <- list(fDOM.mod.arma.1.1, fDOM.mod.arma.1.2, fDOM.mod.arma.2.1, fDOM.mod.arma.2.2)
aictab(cand.set = models) # fDOM.mod.arma.2.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(fDOM.mod.arma.2.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(fDOM.mod.arma.2.1)
intervals(fDOM.mod.arma.2.1)
plot(print(confint(site.ID.comp)))

anova(fDOM.mod.arma.2.1)

```
MOOS:CARI
MOOS:POKE
MOOS:STRT

VAUL:POKE
VAUL:STRT
VAUL:CARI
VAUL:FRCH


### SPC ### 
```{r}
ggplot(mean_daily_2019, aes(x = julian, y = dailySPC, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

spc.2019 <- ggplot(mean_daily_2019, aes(x = site.ID, y = dailySPC, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("") +
  ylab("") +
  theme_classic()
```

# gls 
```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019)

```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
VAUL has way more heterogeneity that needs to be dealt with 


# gls 
```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2019)
```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
hetergeneous variance and normality is addressed...yay!

# corAR1 structure 
```{r}
SPC.mod.ar1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.ar1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.1.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
SPC.mod.arma.2.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
SPC.mod.arma.1.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
SPC.mod.arma.2.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(SPC.mod.arma.1.1, SPC.mod.arma.1.2, SPC.mod.arma.2.1, SPC.mod.arma.2.2)
aictab(cand.set = models) # SPC.mod.arma.2.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.arma.2.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(SPC.mod.arma.2.1)
intervals(SPC.mod.arma.2.1)
plot(print(confint(site.ID.comp)))
anova(SPC.mod.arma.2.1)

```
VAUL:CARI
VAUL:FRCH


### Turb ### 
```{r}
ggplot(mean_daily_2019, aes(x = julian, y = dailyTurb, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

turb.2019 <- ggplot(mean_daily_2019, aes(x = site.ID, y = dailyTurb, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("") +
  ylab("") +
  theme_classic()
```

# gls 
```{r}
turb.mod.gls <- gls(dailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019)
```

# diagnostic plots 
```{r}
plot(turb.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
we have a lot of hetergenous variance, lets tackle that first 


```{r}
turb.mod.gls <- gls(dailyTurb ~ site.ID, 
               na.action = na.omit,
               weights = varfixed,
               data = mean_daily_2019)
```

# diagnostic plots 
```{r}
plot(turb.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
normality is still not good. lets log transform as well 

#log transformed 
```{r}
mean_daily_2019$logDailyTurb <- log(mean_daily_2019$dailyTurb)

turb.mod.gls.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2019)

```

# diagnostic plots 
```{r}
plot(turb.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls.log, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls.log, ~ resid(., type = "p"), abline = c(0,1))

```
this looks best, lets use the log transformed dataset 


Looks like we have lots of outliers here but our normality isnt good either so lets log transform first and then investigate outliers

# corAR1 structure 
```{r}
turb.mod.ar1.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2019, 
               correlation = corAR1(form = ~ julian|site.ID))

```


# ACF plot 
```{r}
Ear1<-residuals(turb.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2019$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2019$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2019$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation but may work 

# corARMA structure 
```{r}
turb.mod.arma.2.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2019$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.2.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2019$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2019$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(turb.mod.arma.1.1, turb.mod.arma.1.2, turb.mod.arma.2.1, turb.mod.arma.2.2)
aictab(cand.set = models) # no3.mod.arma.1.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.arma.2.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(turb.mod.arma.2.2)
intervals(turb.mod.arma.2.2)
plot(print(confint(site.ID.comp)))
anova(turb.mod.arma.2.2)

```
FRCH:CARI


# 2020 #
```{r}
mean_daily_2020 <- subset(mean_daily, year == "2020")
mean_daily_2020$site.ID <- as.factor(mean_daily_2020$site.ID)

ggplot(mean_daily_2020, aes(x = julian, y = dailyNO3, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

no3.2020 <- ggplot(mean_daily_2020, aes(x = site.ID, y = dailyNO3, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") + 
  theme_classic() +
  xlab("Site") +
  ylab(vn)

ggsave("NO3_2020.pdf",
       path = here("plots", "Chems_year"),
       width = 10, height = 10)

```

# gls
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020)
```


# diagnostic plots 
```{r}
plot(no3.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
looks like our variance is too different, lets try that first 

```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit,
               weights = varfixed,
               data = mean_daily_2020)
```


# diagnostic plots 
```{r}
plot(no3.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
this looks good!

# CorAR1 structure #
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(no3.mod.gls, type="normalized")
I1<-!is.na(mean_daily_2020$dailyNO3)
Efulla<-vector(length = length(mean_daily_2020$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is doing a pretty good job 

# corARMA structure 
```{r}
NO3.mod.arma.1.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2020$dailyNO3)
Efulla<-vector(length = length(mean_daily_2020$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
We can stop here!

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(NO3.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(NO3.mod.arma.1.1)
intervals(NO3.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(NO3.mod.arma.1.1)

```
FRCH:CARI

MOOS:POKE
MOOS:STRT
MOOS:FRCH

VAUL:FRCH
VAUL:MOOS
VAUL:CARI
VAUL:POKE
VAUL:STRT

### fDOM ### 
```{r}
ggplot(mean_daily_2020, aes(x = julian, y = dailyfDOM, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

fDOM.2020 <- ggplot(mean_daily_2020, aes(x = site.ID, y = dailyfDOM, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("Daily fDOM (QSU)") +
  theme_classic()
```

# gls
```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020)
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
our variances are pretty different lets try that first 

# gls
```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit,
               weights = varfixed,
               data = mean_daily_2020)
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
this looks pretty good 

# corAR1 structure 
```{r}
fDOM.mod.ar1 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020,
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```

 
# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.ar1, type="normalized")
I1<-!is.na(mean_daily_2020$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2020$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.1.1 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2020$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2020$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
we can stop here!


# generalized linear hypotheses
```{r}
site.ID.comp <- glht(fDOM.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(fDOM.mod.arma.1.1)
intervals(fDOM.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(fDOM.mod.arma.1.1)

```
POKE:CARI
POKE:STRT
POKE:FRCH
POKE:MOOS

MOOS:FRCH
MOOS:STRT
MOOS:CARI

VAUL:POKE
VAUL:STRT
VAUL:CARI
VAUL:FRCH
VAUL:MOOS

### SPC ### 
```{r}
ggplot(mean_daily_2020, aes(x = julian, y = dailySPC, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

spc.2020 <- ggplot(mean_daily_2020, aes(x = site.ID, y = dailySPC, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("Daily SPC (µS/cm)") +
  theme_classic()
```

# gls 
```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020)

```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
VAUL is way different 

# gls 
```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2020)

```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
looks a lot better here 

# corAR1 structure 
```{r}
SPC.mod.ar1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020,
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.ar1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.1.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
SPC.mod.arma.2.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still correlation

# corARMA structure 
```{r}
SPC.mod.arma.1.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
SPC.mod.arma.2.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2019, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2019$dailySPC)
Efulla<-vector(length = length(mean_daily_2019$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation but this is the best one yet so lets interpret this model 

# AIC 
```{r}
models <- list(SPC.mod.arma.1.1, SPC.mod.arma.1.2, SPC.mod.arma.2.1, SPC.mod.arma.2.2)
aictab(cand.set = models) # SPC.mod.arma.2.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.arma.2.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(SPC.mod.arma.2.1)
intervals(SPC.mod.arma.2.1)
plot(print(confint(site.ID.comp)))
anova(SPC.mod.arma.2.1)

```
VAUL:CARI
VAUL:FRCH


### Turb ### 
```{r}
ggplot(mean_daily_2020, aes(x = julian, y = dailyTurb, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

turb.2020 <- ggplot(mean_daily_2020, aes(x = site.ID, y = dailyTurb, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("Daily Turbidity (FNU)") +
  theme_classic()
```
# gls
```{r}
turb.mod.gls <- gls(dailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020)

```

# diagnostic plots 
```{r}
plot(turb.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
lets log transform 

# gls
```{r}
mean_daily_2020$logDailyTurb <- log(mean_daily_2020$dailyTurb)

turb.mod.gls.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020)

```

# diagnostic plots 
```{r}
plot(turb.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls.log, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls.log, ~resid(., type = "p"), abline = c(0,1))

```
variance is still different 

```{r}
turb.mod.gls.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2020)
```

# diagnostic plots 
```{r}
plot(turb.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls.log, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls.log, ~resid(., type = "p"), abline = c(0,1))

```
lets go with this one 

# corAR1 structure 
```{r}
turb.mod.ar1.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020,
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(turb.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2020$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2020$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is doing pretty dang good 

# corARMA structure 
```{r}
turb.mod.arma.1.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2020$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2020$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020,
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2020$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2020$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
turb.mod.arma.2.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2020$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2020$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation at the 9th lag but that is itation in the later lags

# corARMA structure 
```{r}
turb.mod.arma.2.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2020, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2020$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2020$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(turb.mod.arma.1.1, turb.mod.arma.1.2, turb.mod.arma.2.1, turb.mod.arma.2.2)
aictab(cand.set = models) # no3.mod.arma.1.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.arma.2.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(turb.mod.arma.2.2)
intervals(turb.mod.arma.2.2)
plot(print(confint(site.ID.comp)))
anova(turb.mod.arma.2.2)

```
CARI:FRCH



# 2021 #
```{r}
mean_daily_2021 <- subset(mean_daily, year == "2021")
mean_daily_2021$site.ID <- as.factor(mean_daily_2021$site.ID)

ggplot(mean_daily_2021, aes(x = julian, y = dailyNO3, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

no3.2021 <- ggplot(mean_daily_2021, aes(x = site.ID, y = dailyNO3, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab(vn) +
  theme_classic()
```

# gls
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021)
              
```

# diagnostic plots 
```{r}
plot(no3.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(no3.mod.gls, dailyNO3 ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(no3.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
looks good to me 

# CorAR1 structure #
```{r}
no3.mod.gls <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(no3.mod.gls, type="normalized")
I1<-!is.na(mean_daily_2021$dailyNO3)
Efulla<-vector(length = length(mean_daily_2021$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 does not adequately handle temporal autocorrelation 

# corARMA structure 
```{r}
NO3.mod.arma.1.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2021$dailyNO3)
Efulla<-vector(length = length(mean_daily_2021$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
lag at 4 

# corARMA structure 
```{r}
NO3.mod.arma.1.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailyNO3)
Efulla<-vector(length = length(mean_daily_2021$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# corARMA structure 
```{r}
NO3.mod.arma.2.1 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailyNO3)
Efulla<-vector(length = length(mean_daily_2021$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# corARMA structure 
```{r}
NO3.mod.arma.2.2 <- gls(dailyNO3 ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(NO3.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailyNO3)
Efulla<-vector(length = length(mean_daily_2021$dailyNO3))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
# AIC 
```{r}
models <- list(NO3.mod.arma.1.1, NO3.mod.arma.1.2, NO3.mod.arma.2.1, NO3.mod.arma.2.2)
aictab(cand.set = models) # NO3.mod.arma.1.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(NO3.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(NO3.mod.arma.1.1)
intervals(NO3.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(NO3.mod.arma.1.1)

```
VAUL:POKE

### fDOM ### 
```{r}
mean_daily_2021 <- mean_daily_2021 %>%
  mutate(across(c(dailyfDOM), 
                ~ifelse(dailyfDOM < 0, NA, .)))

mean_daily_2021 <- mean_daily_2021 %>%
  mutate(across(c(dailyfDOM),
                ~ifelse(site.ID == "FRCH" & dailyfDOM < 20, NA, .)))

ggplot(mean_daily_2021, aes(x = julian, y = dailyfDOM, color = site.ID)) +
  geom_line() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

fDOM.2021 <- ggplot(mean_daily_2021, aes(x = site.ID, y = dailyfDOM, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("") +
  theme_classic()
```

# gls
```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021)
            
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
Variance is pretty different, lets do that first 

```{r}
fDOM.mod.gls <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2021)
            
```

# diagnostic plots 
```{r}
plot(fDOM.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
lets log transform 

# log transformed 
```{r}
mean_daily_2021$logDailyfDOM <- log(mean_daily_2021$dailyfDOM)

fDOM.mod.gls.log <- gls(logDailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed)

```
  
```{r}
plot(fDOM.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(fDOM.mod.gls.log, dailyfDOM ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(fDOM.mod.gls.log, ~resid(., type = "p"), abline = c(0,1))

```             
lets use untransformed data here

# corAR1 structure 
```{r}
fDOM.mod.ar1 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021,
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```


# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2021$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2021$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.1.1 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2021$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2021$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
fDOM.mod.arma.2.1 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2021$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2021$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
same as above

# corARMA structure 
```{r}
fDOM.mod.arma.1.2 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2021$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation in the later lags

# corARMA structure 
```{r}
fDOM.mod.arma.2.2 <- gls(dailyfDOM ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(fDOM.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailyfDOM)
Efulla<-vector(length = length(mean_daily_2021$dailyfDOM))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(fDOM.mod.arma.1.1, fDOM.mod.arma.1.2, fDOM.mod.arma.2.1, fDOM.mod.arma.2.2)
aictab(cand.set = models) # fDOM.mod.arma.2.2 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(fDOM.mod.arma.2.2, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(fDOM.mod.arma.2.2)
intervals(fDOM.mod.arma.2.2)
plot(print(confint(site.ID.comp)))
anova(fDOM.mod.arma.2.2)

```

STRT:POKE

MOOS:FRCH
MOOS:POKE
MOOS:STRT

VAUL:POKE
VAUL:STRT
VAUL:CARI
VAUL:FRCH

### SPC ### 
```{r}
ggplot(mean_daily_2021, aes(x = julian, y = dailySPC, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

spc.2021 <- ggplot(mean_daily_2021, aes(x = site.ID, y = dailySPC, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("") + 
  theme_classic()
```

# gls
```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021)

```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
those pesky variances are at it again

```{r}
SPC.mod.gls <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               weights = varfixed,
               data = mean_daily_2021)

```

# diagnostic plots 
```{r}
plot(SPC.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(SPC.mod.gls, dailySPC ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(SPC.mod.gls, ~ resid(., type = "p"), abline = c(0,1))

```
much better

# corAR1 structure 
```{r}
SPC.mod.ar1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corAR1(form = ~ julian|site.ID))
```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.ar1, type="normalized")
I1<-!is.na(mean_daily_2021$dailySPC)
Efulla<-vector(length = length(mean_daily_2021$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.1.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2021$dailySPC)
Efulla<-vector(length = length(mean_daily_2021$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.2.1 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2021$dailySPC)
Efulla<-vector(length = length(mean_daily_2021$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
SPC.mod.arma.1.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))
```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailySPC)
Efulla<-vector(length = length(mean_daily_2021$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
SPC.mod.arma.2.2 <- gls(dailySPC ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               weights = varfixed,
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))

```

# ACF plot 
```{r}
Ear1<-residuals(SPC.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2021$dailySPC)
Efulla<-vector(length = length(mean_daily_2021$dailySPC))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

```{r}
models <- list(SPC.mod.arma.1.1, SPC.mod.arma.1.2, SPC.mod.arma.2.1, SPC.mod.arma.2.2)
aictab(cand.set = models) # SPC.mod.arma.1.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(SPC.mod.arma.1.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(SPC.mod.arma.1.1)
plot(print(confint(site.ID.comp)))
anova(SPC.mod.arma.1.1)

```

CARI:MOOS
CARI:POKE
CARI:STRT

POKE:FRCH

VAUL:CARI
VAUL:FRCH
VAUL:MOOS
VAUL:POKE
VAUL:STRT

### Turb ### 
```{r}
ggplot(mean_daily_2021, aes(x = julian, y = dailyTurb, color = site.ID)) +
  geom_line() +
    scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_wrap(~site.ID, scales = "free") +
  theme_classic()

turb.2021 <- ggplot(mean_daily_2021, aes(x = site.ID, y = dailyTurb, fill = site.ID)) +
  geom_boxplot() +
    scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("") +
  theme_classic()
```

# gls
```{r}
turb.mod.gls <- gls(dailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021)

```

# diagnostic plots 
```{r}
plot(turb.mod.gls, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls, dailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls, ~resid(., type = "p"), abline = c(0,1))

```
lets log transform 

```{r}
mean_daily_2021$logDailyTurb <- log(mean_daily_2021$dailyTurb)

turb.mod.gls.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021)

```

# diagnostic plots 
```{r}
plot(turb.mod.gls.log, resid(., type = "p") ~ fitted(.), abline = 0)

plot(turb.mod.gls.log, logDailyTurb ~ fitted(.) | site.ID, abline = c(0,1))

qqnorm(turb.mod.gls.log, ~resid(., type = "p"), abline = c(0,1))

```
lets go with this 

# corAR1 structure 
```{r}
turb.mod.ar1.log <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corAR1(form = ~ julian|site.ID))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.ar1.log, type="normalized")
I1<-!is.na(mean_daily_2021$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2021$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
AR1 is not adequately handling the temporal autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.1, type="normalized")
I1<-!is.na(mean_daily_2021$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2021$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.1.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 1, q = 2))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.1.2, type="normalized")
I1<-!is.na(mean_daily_2021$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2021$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation

# corARMA structure 
```{r}
turb.mod.arma.2.1 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 1))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.1, type="normalized")
I1<-!is.na(mean_daily_2021$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2021$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# corARMA structure 
```{r}
turb.mod.arma.2.2 <- gls(logDailyTurb ~ site.ID, 
               na.action = na.omit, 
               data = mean_daily_2021, 
               correlation = corARMA(form = ~ julian|site.ID, p = 2, q = 2))
```

# ACF plot 
```{r}
Ear1<-residuals(turb.mod.arma.2.2, type="normalized")
I1<-!is.na(mean_daily_2021$logDailyTurb)
Efulla<-vector(length = length(mean_daily_2021$logDailyTurb))
Efulla<-NA
Efulla[I1]<-Ear1
acf(Efulla, na.action=na.pass)
pacf(Efulla, na.action=na.pass)
```
Still autocorrelation 

# AIC 
```{r}
models <- list(turb.mod.arma.1.1, turb.mod.arma.1.2, turb.mod.arma.2.1, turb.mod.arma.2.2)
aictab(cand.set = models) # turb.mod.arma.2.1 is the best model
```

# generalized linear hypotheses
```{r}
site.ID.comp <- glht(turb.mod.arma.2.1, linfct = mcp(site.ID = "Tukey"))
summary(site.ID.comp)
summary(turb.mod.arma.2.1)
intervals(turb.mod.arma.2.1)
plot(print(confint(site.ID.comp)))
```
CARI:FRCH
CARI:MOOS

VAUL:CARI
VAUL:POKE


### PLOTS FOR THESIS ###

```{r}
# ggarrange(no3.2020, no3.2021,
#            ncol = 2, nrow = 1,
#            common.legend = TRUE,
#            labels = c("A)", "B)"),
#         legend = "bottom")
# 
# ggsave("NO3_2020_2021.pdf",
#        path = here("plots", "Chems_year"),
#        width = 15, height = 10)
# 
# ggarrange(fDOM.2018, fDOM.2019,
#           fDOM.2020, fDOM.2021,
#            ncol = 2, nrow = 2,
#            common.legend = TRUE,
#            labels = c("A)", "B)",
#                       "C)", "D)"),
#         legend = "bottom")
# 
# ggsave("fDOM_2018_2021.pdf",
#        path = here("plots", "Chems_year"),
#        width = 15, height = 10)
# 
# ggarrange(spc.2018, spc.2019,
#           spc.2020, spc.2021,
#            ncol = 2, nrow = 2,
#            common.legend = TRUE,
#            labels = c("A)", "B)",
#                       "C)", "D)"),
#         legend = "bottom")
# 
# ggsave("SPC_2018_2021.pdf",
#        path = here("plots", "Chems_year"),
#        width = 15, height = 10)
# 
# ggarrange(turb.2018, turb.2019,
#           turb.2020, turb.2021,
#            ncol = 2, nrow = 2,
#            common.legend = TRUE,
#            labels = c("A)", "B)",
#                       "C)", "D)"),
#         legend = "bottom")
# 
# ggsave("Turb_2018_2021.pdf",
#        path = here("plots", "Chems_year"),
#        width = 15, height = 10)


# THESE ARE THE ONES THAT I AM USING 
vn = expression(paste(N*O[3]^"-"*(μM)))

mean_daily_new <- mean_daily
mean_daily_new$site.ID <- factor(mean_daily_new$site.ID,     # Reorder factor levels
                         c("CARI", "FRCH", "VAUL", "MOOS", "POKE", "STRT"))

ggplot(mean_daily_new, aes(x = site.ID, y = dailyNO3, pattern = PF, fill = site.ID)) +
  geom_boxplot() +
   geom_boxplot_pattern(position = position_dodge(preserve = "single"), color = "black", pattern_fill = "white", pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.025, pattern_key_scale_factor = 0.6) +
  scale_pattern_manual(values = c(High = "stripe", Moderate = "none")) +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#E7298A", "#A6761D", "#6A3D9A", "#66C2A5")) +
  xlab("") +
  ylab(vn) +
  theme_classic() +
  facet_wrap(~year) +
  theme(axis.text.x=element_text(size=20, angle = 90, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.position = "none",
        strip.text = element_text(size = 20))

ggsave("NO3_facet.pdf",
       path = here("plots", "Chems_year"),
       width = 10, height = 10)


ggplot(mean_daily_new, aes(x = site.ID, y = dailyfDOM, pattern = PF, fill = site.ID)) +
  geom_boxplot() +
  geom_boxplot_pattern(position = position_dodge(preserve = "single"), color = "black", pattern_fill = "white", pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.025, pattern_key_scale_factor = 0.6) +
  scale_pattern_manual(values = c(High = "stripe", Moderate = "none")) +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#E7298A", "#A6761D", "#6A3D9A", "#66C2A5"))+
  xlab("") +
  ylab("fDOM (QSU)") +
  theme_classic() +
  facet_wrap(~year) +
  theme(axis.text.x=element_text(size=20, angle = 90, vjust = 0.5, hjust = 1), 
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.position = "none",
        strip.text = element_text(size = 20)) 

ggsave("fDOM_facet.pdf",
       path = here("plots", "Chems_year"),
       width = 10, height = 10)

ggplot(mean_daily_new, aes(x = site.ID, y = dailySPC, pattern = PF, fill = site.ID)) +
  geom_boxplot() +
  geom_boxplot_pattern(position = position_dodge(preserve = "single"), color = "black", pattern_fill = "white", pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.025, pattern_key_scale_factor = 0.6) +
  scale_pattern_manual(values = c(High = "stripe", Moderate = "none")) +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#E7298A", "#A6761D", "#6A3D9A", "#66C2A5")) +
  scale_y_continuous(trans='log10') +
  xlab("") +
  ylab("SPC (μS/cm)") +
  theme_classic() +
  facet_wrap(~year) +
  theme(axis.text.x=element_text(size=20, angle = 90, vjust = 0.5, hjust = 1), 
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.position = "none",
        strip.text = element_text(size = 20)) 

ggsave("SPC_facet.pdf",
       path = here("plots", "Chems_year"),
       width = 11, height = 11)


ggplot(mean_daily_new, aes(x = site.ID, y = dailyTurb, pattern = PF, fill = site.ID)) +
  geom_boxplot() +
  geom_boxplot_pattern(position = position_dodge(preserve = "single"), color = "black", pattern_fill = "white", pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.025, pattern_key_scale_factor = 0.6) +
  scale_pattern_manual(values = c(High = "stripe", Moderate = "none")) +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#E7298A", "#A6761D", "#6A3D9A", "#66C2A5")) +
  scale_y_continuous(trans='log10') +
  xlab("") +
  ylab("Turbidity (FNU)") +
  theme_classic() +
  facet_wrap(~year) +
  theme(axis.text.x=element_text(size=20, angle = 90, vjust = 0.5, hjust = 1), 
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.position = "none",
        strip.text = element_text(size = 20)) 

ggsave("Turb_facet.pdf",
       path = here("plots", "Chems_year"),
       width = 11, height = 11)


# brackets # When exporting it to a different size the brackets get all out of whack so it takes me just as much time doing it in word as it does here so let me just do it word 
# ggplot(mean_daily_new, aes(x = site.ID, y = dailyNO3, pattern = PF, fill = site.ID)) +
#   geom_boxplot() +
#   geom_boxplot_pattern(position = position_dodge(preserve = "single"), color = "black", pattern_fill = "white", pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.025, pattern_key_scale_factor = 0.6) +
#   scale_pattern_manual(values = c(High = "stripe", Moderate = "none")) +
#   scale_fill_manual(values=c("#3288BD","#FF7F00", "#E7298A", "#A6761D", "#6A3D9A", "#66C2A5")) +
#   xlab("") +
#   ylab(vn) +
#   theme_classic() +
#   facet_wrap(~year) +
#   theme(axis.text.x=element_text(size=20, angle = 90, vjust = 0.5, hjust=1),
#         axis.text.y = element_text(size = 20),
#         axis.title.x = element_text(size = 20),
#         axis.title.y = element_text(size = 20),
#         legend.position = "none",
#         strip.text = element_text(size = 20))
# 
# grid.brackets(150, 335, 65, 335, lwd=1, ticks=NA, type = 4)
# grid.brackets(245, 335, 155, 335, lwd=1, ticks=NA, type = 4)
# 
# grid.brackets(340, 335, 255, 335, lwd=1, ticks=NA, type = 4)
# grid.brackets(430, 335, 345, 335, lwd=1, ticks=NA, type = 4)
# 
# grid.text(x=unit(20,'npc'), y=unit(10,'npc'),
#           label=expression(paste('Unburned'),'type=4'), hjust = -1.75, vjust=0)

```



### CV of daily concentrations ### 

```{r}
mean_daily <- read.csv(here("Output_from_analysis", "08_Catchment_characteristics", "mean_daily.csv"))

mean_daily$datetimeAK <- ymd(mean_daily$day)
mean_daily <- mean_daily[order(mean_daily$year, mean_daily$site.ID), ]

mean_daily$year <- as.character(mean_daily$year)

# mean concentration across years for each site 
mean_daily_site <- mean_daily %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanNO3 = mean(dailyNO3, na.rm = TRUE),
                   meanfDOM = mean(dailyfDOM, na.rm = TRUE),
                   meanSPC = mean(dailySPC, na.rm = TRUE),
                   meanTurb = mean(dailyTurb, na.rm = TRUE))



mean_daily_long <- mean_daily %>%
  pivot_longer(
    cols = starts_with("daily"),
    names_to = "response_var",
    names_prefix = "wk",
    values_to = "concentration") # converting to a long format so each response_var is within a single column

CV_mean_conc <- mean_daily_long %>% group_by(response_var,site.ID, year) %>%
  dplyr::summarise(MEANconc = mean(concentration, na.rm = TRUE),
                   SDconc = sd(concentration, na.rm = TRUE),
                   CVconc = SDconc/MEANconc)


CV_mean_conc_all_years <- CV_mean_conc %>% 
  group_by(response_var,site.ID) %>%
  dplyr::summarise(meanCV = mean(CVconc, na.rm = TRUE))


##subsetting by solute
# NO3 #
CV_NO3 = subset(CV_mean_conc, response_var == "dailyNO3")
# fDOM #
CV_fDOM = subset(CV_mean_conc, response_var == "dailyfDOM")
# SPC #
CV_SPC = subset(CV_mean_conc, response_var == "dailySPC")
# turb #
CV_turb = subset(CV_mean_conc, response_var == "dailyTurb")



CV_mean_site_NO3 <- CV_NO3 %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanNO3 = mean(CVconc, na.rm = TRUE))

CV_mean_site_fDOM <- CV_fDOM %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanfDOM = mean(CVconc, na.rm = TRUE))

CV_mean_site_SPC <- CV_SPC %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanSPC = mean(CVconc, na.rm = TRUE))

CV_mean_site_turb <- CV_turb %>% 
  group_by(site.ID) %>% 
  dplyr::summarise(meanTurb = mean(CVconc, na.rm = TRUE))

CV_site <- full_join(CV_mean_site_NO3, CV_mean_site_fDOM)
CV_site <- full_join(CV_site, CV_mean_site_SPC)
CV_site <- full_join(CV_site, CV_mean_site_turb)

write.csv(CV_site, "~/Documents/Storms_clean_repo/Output_from_analysis/10_gls_models/CVs_site.csv")




```

```{r}
ggplot(CV_mean_conc, aes(site.ID, CVconc, color = site.ID)) +
  geom_point() +
  scale_color_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A")) +
  facet_grid(response_var ~ year, scales = "free") +
  theme_bw()

# ggsave("CV_all_sites.pdf",
#        path = here("plots", "Chem_variation"),
#        width = 10, height = 10)

```


```{r}
#NO3
cv.no3 <- ggplot(CV_NO3, aes(site.ID, CVconc, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#3288BD", "#FF7F00","#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab(vn) +
  theme_classic()

# ggsave("CV_NO3_sites.pdf",
#        path = here("plots", "Chem_variation"),
#        width = 10, height = 10)

##### TKH  note: there is only one observation per site*year and therefore no way to estimate a variance for the interaction term. This should be a mixed effects model, with year as a random effect.
NO3.CV.mod <- lmer(CVconc ~ site.ID + (1|year), data = CV_NO3)

plot(NO3.CV.mod)
qqnorm(resid(NO3.CV.mod))
summary(NO3.CV.mod)
anova(NO3.CV.mod)
summary(NO3.CV.mod, ddf)
emmeans(NO3.CV.mod, list(pairwise ~ site.ID), adjust = "tukey")

# add post hoc pairwise comparisons

# ANOVA #
anova <- aov(CVconc ~ site.ID, data = CV_NO3)
summary(anova)
```

```{r}
#fDOM
cv.fDOM <- ggplot(CV_fDOM, aes(site.ID, CVconc, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#3288BD", "#FF7F00","#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  theme_classic() +
  xlab("Site") +
  ylab("CV-fDOM")

ggsave("CV_fDOM_sites.pdf",
       path = here("plots", "Chem_variation"),
       width = 10, height = 10)

fDOM.CV.mod <- lmer(CVconc ~ site.ID + (1|year), data = CV_fDOM)

plot(fDOM.CV.mod)
qqnorm(resid(fDOM.CV.mod))

summary(fDOM.CV.mod)

emmeans(fDOM.CV.mod, list(pairwise ~ site.ID), adjust = "tukey")

# ANOVA # 
anova <- aov(CVconc ~ site.ID, data = CV_fDOM)
summary(anova)


```
 normality isnt the best 

```{r}
#log transform 
CV_fDOM$logCVconc <- log(abs(CV_fDOM$CVconc))

fDOM.CV.mod.log <- lmer(logCVconc ~ site.ID + (1|year), data = CV_fDOM)

# boundary (singular) fit...not good. use the untransformed model 



```

```{r}
#SPC
cv.spc <- ggplot(CV_SPC, aes(site.ID, CVconc, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#3288BD", "#FF7F00","#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("CV-SPC") +
  theme_classic()

ggsave("CV_SPC_sites.pdf",
       path = here("plots", "Chem_variation"),
       width = 10, height = 10)

SPC.CV.mod <- lmer(CVconc ~ site.ID + (1|year), data = CV_SPC)

plot(SPC.CV.mod)
qqnorm(resid(SPC.CV.mod))

summary(SPC.CV.mod)

emmeans(SPC.CV.mod, list(pairwise ~ site.ID), adjust = "tukey")

# ANOVA # 
anova <- aov(CVconc ~ site.ID, data = CV_SPC)
summary(anova)


```


```{r}
#turb
cv.turb <- ggplot(CV_turb, aes(site.ID, CVconc, fill = site.ID)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#3288BD", "#FF7F00","#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("Site") +
  ylab("CV-Turb") +
  theme_classic()

ggsave("CV_turb_sites.pdf",
       path = here("plots", "Chem_variation"),
       width = 10, height = 10)

turb.CV.mod <- lmer(CVconc ~ site.ID + (1|year), data = CV_turb)

plot(turb.CV.mod)
qqnorm(resid(turb.CV.mod))

summary(turb.CV.mod)

emmeans(turb.CV.mod, list(pairwise ~ site.ID), adjust = "tukey")

# ANOVA # 
anova <- aov(CVconc ~ site.ID, data = CV_turb)
summary(anova)


```
lets log transform for normality:


```{r}
#log transform 
CV_turb$logCVconc <- log(abs(CV_turb$CVconc))
turb.log <- aov(logCVconc ~ site.ID*year, 
           data = CV_turb)

plot(turb.log)

```

```{r} 
summary(turb.log) # site.ID and year are significant
TukeyHSD(turb.log, which = "site.ID")

#CARI/FRCH
#CARI/MOOS
#CARI/POKE
#CARI/STRT
#CARI/VAUL

# this is just because there is that errant point in 2018 for CARI so this probably isnt real as of 9/22
# ANOVA # 
anova <- aov(logCVconc ~ site.ID, data = CV_turb)
summary(anova)
```


### PLOTS FOR THESIS ###

```{r}
library(facetscales)
ggarrange(cv.no3, cv.fDOM,
          cv.spc, cv.turb,
           ncol = 2, nrow = 2,
           common.legend = TRUE,
           labels = c("A)", "B)", 
                      "C)", "D)"),
        legend = "bottom")

ggsave("CV_all_solutes.pdf",
       path = here("plots", "Chem_variation"),
       width = 15, height = 10)

scales_y <- list(
  `dailyfDOM` = scale_y_continuous(limits = c(0.05, 0.5), breaks = seq(0.05, 0.5, 0.1)),
  `dailyNO3` = scale_y_continuous(limits = c(0.05, 0.5), breaks = seq(0.05, 0.5, 0.1)),
  `dailySPC` = scale_y_continuous(limits = c(0.05, 0.5), breaks = seq(0.05, 0.5, 0.1)),
  `dailyTurb` = scale_y_continuous(limits = c(0, 5), breaks = seq(0.0, 5, 1))
)

supp.labs <- c(`dailyfDOM` = "CV-fDOM",
               `dailyNO3` = "CV-NO3-",
               `dailySPC` = "CV-SPC",
               `dailyTurb` = "CV-turbidity")
ggplot(CV_mean_conc, aes(x = site.ID, y = CVconc, fill = site.ID)) +
  geom_boxplot() +
  scale_y_continuous(trans='log10') +
  scale_fill_manual(values=c("#3288BD","#FF7F00", "#A6761D", "#6A3D9A", "#66C2A5", "#E7298A"), "Site") +
  xlab("") +
  ylab("") +
  theme_classic() +
  facet_wrap(~response_var, scales = "free_y", 
             labeller = as_labeller(supp.labs)) +
  theme(axis.text.x=element_text(size=15), 
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.key.size = unit(2.0, 'cm'),
        strip.text = element_text(size = 20))


ggsave("CV_facet.pdf",
       path = here("plots", "Chem_variation"),
       width = 10, height = 10)
```





